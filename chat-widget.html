<!-- Chat bubble button (floating launcher) -->
<div id="chatbot-bubble">
  <button id="chatbot-open" type="button">Chat</button>
</div>

<!-- Chat window container -->
<div id="chatbot-box" aria-hidden="true">
  <div id="chatbot-header">
    <strong>Chat</strong>
    <!-- Close button inside chat window -->
    <button id="chatbot-close" type="button" aria-label="Close chat">✕</button>
  </div>

  <!-- Message container -->
  <div id="chatbot-messages"></div>

  <!-- Input form -->
  <form id="chatbot-form">
    <input 
      id="chatbot-input" 
      type="text" 
      placeholder="Kirjoita viesti…" 
      autocomplete="off" 
    />
    <button id="chatbot-send" type="submit">Lähetä</button>
  </form>
</div>

<style>
  /* Floating bubble button */
  #chatbot-bubble{
    position:fixed;
    right:20px;
    bottom:20px;
    z-index:999999;
  }

  #chatbot-open{
    padding:12px 14px;
    border-radius:999px;
    cursor:pointer;
  }

  /* Chat window */
  #chatbot-box{
    display:none;
    position:fixed;
    right:20px;
    bottom:70px;
    width:350px;
    max-width:95vw;
    height:480px;
    max-height:85vh;
    background:#fff;
    border:1px solid #ddd;
    border-radius:12px;
    z-index:999999;
    overflow:visible;
    font-family:system-ui;
  }

  /* Active state */
  #chatbot-box.active{
    display:block;
  }

  /* Header */
  #chatbot-header{
    padding:10px 12px;
    border-bottom:1px solid #eee;
    display:flex;
    justify-content:space-between;
    align-items:center;
  }

  /* Messages area */
  #chatbot-messages{
    padding:12px;
    height:320px;
    overflow:auto;
    background:#fafafa;
  }

  /* Input form */
  #chatbot-form{
    display:flex;
    gap:8px;
    padding:10px;
    border-top:1px solid #eee;
  }

  #chatbot-input{
    flex:1;
    padding:10px;
    border:1px solid #ddd;
    border-radius:10px;
    min-width:0;
  }

  #chatbot-send{
    padding:10px 12px;
    border-radius:10px;
    cursor:pointer;
  }
</style>

<script>
(function(){

  // API endpoint
  const API_URL = "YOUR_API_URL";

  /**
   * Adds a chat message to the message container
   * @param {HTMLElement} messages - message container element
   * @param {string} text - message content
   * @param {"user"|"bot"} who - sender
   */
  function addMsg(messages, text, who){
    const el = document.createElement("div");

    // Basic styling
    el.style.margin = "8px 0";
    el.style.padding = "10px";
    el.style.borderRadius = "10px";
    el.style.maxWidth = "90%";
    el.style.whiteSpace = "pre-wrap";

    // Different styles for user and bot
    if (who === "user") {
      el.style.background = "#e8f0ff";
      el.style.marginLeft = "auto";
    } else {
      el.style.background = "#fff";
      el.style.border = "1px solid #eee";
      el.style.marginRight = "auto";
    }

    el.textContent = text;
    messages.appendChild(el);

    // Auto-scroll to bottom
    messages.scrollTop = messages.scrollHeight;
  }

  document.addEventListener("DOMContentLoaded", () => {

    // Element references
    const openBtn = document.getElementById("chatbot-open");
    const closeBtn = document.getElementById("chatbot-close");
    const box = document.getElementById("chatbot-box");
    const messages = document.getElementById("chatbot-messages");
    const form = document.getElementById("chatbot-form");
    const input = document.getElementById("chatbot-input");

    if (!openBtn || !closeBtn || !box || !messages || !form || !input) return;

    /**
     * Controls chat open/close state
     * @param {boolean} isOpen
     */
    function setOpenState(isOpen){
      box.classList.toggle("active", isOpen);
      box.setAttribute("aria-hidden", String(!isOpen));

      // Toggle button label
      openBtn.textContent = isOpen ? "Sulje" : "Chat";

      if (isOpen) {

        // Initialize greeting only once
        if (!messages.dataset.inited) {
          addMsg(
            messages,
            "Hello! How can i help you today?",
            "bot"
          );
          messages.dataset.inited = "1";
        }

        // Focus input field
        setTimeout(() => input.focus(), 0);
      }
    }

    /**
     * Toggle chat visibility
     */
    function toggleChat(){
      const isOpen = box.classList.contains("active");
      setOpenState(!isOpen);
    }

    // Open/close from bubble button
    openBtn.addEventListener("click", toggleChat);

    // Close from X button
    closeBtn.addEventListener("click", () => setOpenState(false));

    // Close on ESC key
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") setOpenState(false);
    });

    // Handle message submission
    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const text = (input.value || "").trim();
      if (!text) return;

      input.value = "";
      addMsg(messages, text, "user");

      try {
        const r = await fetch(API_URL, {
          method: "POST",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify({message: text})
        });

        const data = await r.json();
        addMsg(messages, data.reply || "Did not get reply. Try again", "bot");

      } catch {
        addMsg(messages, "Network error. Try again later.", "bot");
      }
    });

  });

})();
</script>
