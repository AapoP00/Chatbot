<div id="chatbot-bubble">
	<button id="chatbot-open" type="button">Chat</button>
</div>

<div id="chatbot-box" aria-hidden="true">
	<div id="chatbot-header">
		<strong>Chat</strong>
		<button id="chatbot-close" type="button">✕</button>
	</div>

	<div id="chatbot-messages"></div>

	<form id="chatbot-form">
		<input id="chatbot-input" type="text" placeholder="Kirjoita viesti…" autocomplete="off" />
		<button id="chatbot-send" type="submit">Lähetä</button>
	</form>
</div>

<script>
(function(){
	const API_URL = "https://api.bittipuisto.fi/chat";

	function addMsg(messages, text, who){
		const el = document.createElement("div");
		el.style.margin = "8px 0";
		el.style.padding = "10px";
		el.style.borderRadius = "10px";
		el.style.maxWidth = "90%";
		el.style.whiteSpace = "pre-wrap";

		if (who === "user") {
			el.style.background = "#e8f0ff";
			el.style.marginLeft = "auto";
		} else {
			el.style.background = "#fff";
			el.style.border = "1px solid #eee";
			el.style.marginRight = "auto";
		}

		el.textContent = text;
		messages.appendChild(el);
		messages.scrollTop = messages.scrollHeight;
	}

	document.addEventListener("DOMContentLoaded", () => {
		const openBtn = document.getElementById("chatbot-open");
		const closeBtn = document.getElementById("chatbot-close");
		const box = document.getElementById("chatbot-box");
		const messages = document.getElementById("chatbot-messages");
		const form = document.getElementById("chatbot-form");
		const input = document.getElementById("chatbot-input");

		if (!openBtn || !closeBtn || !box || !messages || !form || !input) return;

		function setOpenState(isOpen){
			box.classList.toggle("active", isOpen);
			box.setAttribute("aria-hidden", String(!isOpen));

			// Toggle button text
			openBtn.textContent = isOpen ? "Sulje" : "Chat";

			if (isOpen) {
				if (!messages.dataset.inited) {
					addMsg(
						messages,
						"Moi! Olen Bittipuiston luoma esimerkkibotti. Tämä botti käyttää VAIN bittipuisto.fi-sivustolla olevaa tietoa ja vastaa sen mukaan kysymyksiin.",
						"bot"
					);
					messages.dataset.inited = "1";
				}
				setTimeout(() => input.focus(), 0);
			}
		}

		function toggleChat(){
			const isOpen = box.classList.contains("active");
			setOpenState(!isOpen);
		}

		openBtn.addEventListener("click", toggleChat);
		closeBtn.addEventListener("click", () => setOpenState(false));

		document.addEventListener("keydown", (e) => {
			if (e.key === "Escape") setOpenState(false);
		});

		form.addEventListener("submit", async (e) => {
			e.preventDefault();
			const text = (input.value || "").trim();
			if (!text) return;

			input.value = "";
			addMsg(messages, text, "user");

			try {
				const r = await fetch(API_URL, {
					method: "POST",
					headers: {"Content-Type":"application/json"},
					body: JSON.stringify({ message: text })
				});

				const contentType = r.headers.get("content-type") || "";
				let payloadText = "";
				let data = null;

				if (contentType.includes("application/json")) {
					data = await r.json();
				} else {
					payloadText = await r.text();
				}

				if (!r.ok) {
					addMsg(
						messages,
						`Palvelinvirhe (${r.status}). ${data?.detail || payloadText || "Yritä uudelleen."}`,
						"bot"
					);
					return;
				}

				addMsg(messages, data?.reply || "En saanut vastausta juuri nyt.", "bot");
			} catch (e) {
				addMsg(messages, `Tuli virhe yhteydessä: ${e?.message || e}`, "bot");
			}
		});
	});
})();
</script>